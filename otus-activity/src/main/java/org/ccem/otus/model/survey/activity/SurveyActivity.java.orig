package org.ccem.otus.model.survey.activity;

import com.google.gson.GsonBuilder;
import com.google.gson.annotations.SerializedName;

import org.bson.types.ObjectId;
import org.ccem.otus.model.survey.activity.filling.AnswerFill;
import org.ccem.otus.model.survey.activity.filling.FillContainer;
import org.ccem.otus.model.survey.activity.filling.QuestionFill;
import org.ccem.otus.model.survey.activity.interview.Interview;
import org.ccem.otus.model.survey.activity.mode.ActivityMode;
import org.ccem.otus.model.survey.activity.navigation.NavigationTracker;
import org.ccem.otus.model.survey.activity.status.ActivityStatus;
import org.ccem.otus.participant.model.Participant;
import org.ccem.otus.service.extraction.Extractable;
import org.ccem.otus.survey.form.SurveyForm;
import org.ccem.otus.utils.AnswerAdapter;
import org.ccem.otus.utils.ObjectIdAdapter;

import java.util.ArrayList;
import java.util.List;

import javax.faces.context.ExceptionHandler;

public class SurveyActivity implements Extractable {

	private String objectType;
	@SerializedName("_id")
	private ObjectId activityID;
	private SurveyForm surveyForm;
	private ActivityMode mode;
	private Participant participantData;
	private List<Interview> interviews;
	private FillContainer fillContainer;
	private List<ActivityStatus> statusHistory;
	private Boolean isDiscarded;
	private NavigationTracker navigationTracker;

	public SurveyActivity() {
		this.isDiscarded = Boolean.FALSE;
	}

	public void setIsDiscarded(Boolean isDiscarded) {
		this.isDiscarded = isDiscarded;
	}

	public Boolean isDiscarded() {
		return isDiscarded;
	}

	public ObjectId getActivityID() {
		return activityID;
	}

	public String getObjectType() {
		return objectType;
	}

	public SurveyForm getSurveyForm() {
		return surveyForm;
	}

	public ActivityMode getMode() {
		return mode;
	}

	public List<Interview> getInterviews() {
		return interviews;
	}

	public FillContainer getFillContainer() {
		return fillContainer;
	}

	public List<ActivityStatus> getStatusHistory() {
		return statusHistory;
	}

	public Participant getParticipantData() {
		return participantData;
	}

	public NavigationTracker getNavigationTracker() {
		return navigationTracker;
	}

	public static String serialize(SurveyActivity surveyActivity) {
		return getGsonBuilder().create().toJson(surveyActivity);
	}

	public static SurveyActivity deserialize(String surveyActivity) {
		return getGsonBuilder().create().fromJson(surveyActivity, SurveyActivity.class);
	}

	/**
	 * @return a GsonBuilder instance with AnswerAdapter, ObjectIdAdapter
	 *         registered and also all registered adapters of SurveyForm.
	 *         {@link SurveyForm#getGsonBuilder}
	 * 
	 */
	public static GsonBuilder getGsonBuilder() {
		GsonBuilder builder = SurveyForm.getGsonBuilder();

		builder.registerTypeAdapter(AnswerFill.class, new AnswerAdapter());
		builder.registerTypeAdapter(ObjectId.class, new ObjectIdAdapter());
		builder.serializeNulls();

		return builder;
	}

	// TODO: ruim, método está muito espesifico para o csv dessa tarefa!
	// TODO: quem sabe criar uma factory para contrução mais generica!
	@Override
	public List<String> getHeaders() {
<<<<<<< HEAD
		List<String> headers = new ArrayList<String>();
		headers.add(Long.toString(participantData.getRecruitmentNumber()));

		List<QuestionFill> fillingList = fillContainer.getFillingList();
=======
>>>>>>> a71538b0827b56227a58677f93f2e9c1846e67b4
		return null;
	}

	@Override
	public List<Object> getValues() {
		List<Object> extractionValues = new ArrayList<>();

		extractionValues.addAll(_extractBasics());
		extractionValues.addAll(_extractAnswers());

		return extractionValues;
	}


	private List<Object> _extractBasics(){
		List<Object> fullColumns = new ArrayList<>();
		return fullColumns;
	}

	private List<Object> _extractAnswers(){
		List<Object> answers = new ArrayList<>();
		final List<QuestionFill> fillingList = fillContainer.getFillingList();
		fillingList.stream().forEach(questionFill -> answers.add(
				questionFill.getAnswer().extract()
		));
		return answers;
	}
}
